# ğŸš€ Mobile CD Pipeline - PRIMOTEX ERP
# Build e deploy automÃ¡tico para desenvolvimento e produÃ§Ã£o

name: Mobile CD

on:
  push:
    branches: [main]
    paths:
      - 'frontend/mobile/**'
      - '.github/workflows/mobile-cd.yml'
    tags:
      - 'mobile-v*'
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy environment'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - production
      platform:
        description: 'Platform to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ios
          - android

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ inputs.environment || 'auto' }}
  cancel-in-progress: false

defaults:
  run:
    working-directory: ./frontend/mobile

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
  EXPO_APPLE_ID: ${{ secrets.EXPO_APPLE_ID }}
  EXPO_APPLE_PASSWORD: ${{ secrets.EXPO_APPLE_PASSWORD }}

jobs:
  # ğŸ” Determine deployment strategy
  setup:
    name: ğŸ” Setup Deployment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.determine-env.outputs.environment }}
      should-deploy: ${{ steps.determine-env.outputs.should-deploy }}
      platform: ${{ steps.determine-env.outputs.platform }}
      version: ${{ steps.version.outputs.version }}
      
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¯ Determine environment
        id: determine-env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "platform=${{ inputs.platform }}" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=preview" >> $GITHUB_OUTPUT
            echo "platform=all" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/mobile-v* ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "platform=all" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“‹ Extract version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/mobile-v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/mobile-v}" >> $GITHUB_OUTPUT
          else
            echo "version=$(date +'%Y.%m.%d')-${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
          fi

  # ğŸ§ª Pre-deploy validation
  validate:
    name: ğŸ§ª Pre-deploy Validation
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should-deploy == 'true'
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“± Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/mobile/package-lock.json

      - name: ğŸ¯ Setup Expo CLI
        run: npm install -g @expo/cli eas-cli

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run tests
        run: npm test -- --coverage --watchAll=false --passWithNoTests

      - name: ğŸ”§ Validate Expo config
        run: npx expo doctor

      - name: âœ… Pre-deployment checks passed
        run: echo "ğŸ‰ All pre-deployment validations passed!"

  # ğŸ“± Build iOS
  build-ios:
    name: ğŸ“± Build iOS
    runs-on: macos-latest
    needs: [setup, validate]
    if: needs.setup.outputs.should-deploy == 'true' && (needs.setup.outputs.platform == 'all' || needs.setup.outputs.platform == 'ios')
    timeout-minutes: 45
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“± Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/mobile/package-lock.json

      - name: ğŸ¯ Setup Expo and EAS
        run: |
          npm install -g @expo/cli eas-cli
          eas login

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”§ Configure app version
        run: |
          # Update app.json with version info
          node -e "
            const fs = require('fs');
            const app = JSON.parse(fs.readFileSync('app.json', 'utf8'));
            app.expo.version = '${{ needs.setup.outputs.version }}';
            app.expo.ios.buildNumber = '${{ github.run_number }}';
            fs.writeFileSync('app.json', JSON.stringify(app, null, 2));
          "

      - name: ğŸ—ï¸ Build iOS app
        run: |
          if [[ "${{ needs.setup.outputs.environment }}" == "production" ]]; then
            eas build --platform ios --profile production --non-interactive --no-wait
          else
            eas build --platform ios --profile preview --non-interactive --no-wait
          fi

      - name: ğŸ“Š Build summary
        run: |
          echo "## ğŸ“± iOS Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.setup.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Build started successfully" >> $GITHUB_STEP_SUMMARY

  # ğŸ¤– Build Android
  build-android:
    name: ğŸ¤– Build Android
    runs-on: ubuntu-latest
    needs: [setup, validate]
    if: needs.setup.outputs.should-deploy == 'true' && (needs.setup.outputs.platform == 'all' || needs.setup.outputs.platform == 'android')
    timeout-minutes: 45
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“± Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/mobile/package-lock.json

      - name: â˜• Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ¯ Setup Expo and EAS
        run: |
          npm install -g @expo/cli eas-cli
          eas login

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”§ Configure app version
        run: |
          # Update app.json with version info
          node -e "
            const fs = require('fs');
            const app = JSON.parse(fs.readFileSync('app.json', 'utf8'));
            app.expo.version = '${{ needs.setup.outputs.version }}';
            app.expo.android.versionCode = ${{ github.run_number }};
            fs.writeFileSync('app.json', JSON.stringify(app, null, 2));
          "

      - name: ğŸ—ï¸ Build Android app
        run: |
          if [[ "${{ needs.setup.outputs.environment }}" == "production" ]]; then
            eas build --platform android --profile production --non-interactive --no-wait
          else
            eas build --platform android --profile preview --non-interactive --no-wait
          fi

      - name: ğŸ“Š Build summary
        run: |
          echo "## ğŸ¤– Android Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.setup.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Code**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Build started successfully" >> $GITHUB_STEP_SUMMARY

  # ğŸ”„ OTA Updates
  ota-update:
    name: ğŸ”„ OTA Update
    runs-on: ubuntu-latest
    needs: [setup, validate]
    if: needs.setup.outputs.should-deploy == 'true' && needs.setup.outputs.environment != 'production'
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“± Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/mobile/package-lock.json

      - name: ğŸ¯ Setup Expo and EAS
        run: |
          npm install -g @expo/cli eas-cli
          eas login

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”„ Publish OTA update
        run: |
          BRANCH="${{ needs.setup.outputs.environment }}"
          MESSAGE="Update from commit ${GITHUB_SHA:0:7} - ${{ github.event.head_commit.message }}"
          
          eas update --branch $BRANCH --message "$MESSAGE" --non-interactive

      - name: ğŸ“Š OTA Summary
        run: |
          echo "## ğŸ”„ OTA Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${GITHUB_SHA:0:7}" >> $GITHUB_STEP_SUMMARY
          echo "- **Message**: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… OTA update published" >> $GITHUB_STEP_SUMMARY

  # ğŸª Deploy to stores (production only)
  deploy-stores:
    name: ğŸª Deploy to Stores
    runs-on: ubuntu-latest
    needs: [setup, validate, build-ios, build-android]
    if: needs.setup.outputs.environment == 'production' && startsWith(github.ref, 'refs/tags/mobile-v')
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“± Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/mobile/package-lock.json

      - name: ğŸ¯ Setup Expo and EAS
        run: |
          npm install -g @expo/cli eas-cli
          eas login

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ Submit to App Store
        if: needs.setup.outputs.platform == 'all' || needs.setup.outputs.platform == 'ios'
        run: |
          echo "ğŸ Submitting to App Store..."
          eas submit --platform ios --latest --non-interactive

      - name: ğŸ¤– Submit to Google Play
        if: needs.setup.outputs.platform == 'all' || needs.setup.outputs.platform == 'android'
        run: |
          echo "ğŸ¤– Submitting to Google Play..."
          eas submit --platform android --latest --track internal --non-interactive

      - name: ğŸ“Š Store deployment summary
        run: |
          echo "## ğŸª Store Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.setup.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **iOS**: âœ… Submitted to App Store" >> $GITHUB_STEP_SUMMARY
          echo "- **Android**: âœ… Submitted to Google Play (Internal Track)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ğŸ‰ Production deployment completed!" >> $GITHUB_STEP_SUMMARY

  # ğŸ“Š Deployment summary
  deployment-summary:
    name: ğŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs: [setup, validate, build-ios, build-android, ota-update, deploy-stores]
    if: always() && needs.setup.outputs.should-deploy == 'true'
    
    steps:
      - name: ğŸ“Š Generate deployment report
        run: |
          echo "# ğŸš€ PRIMOTEX Mobile Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: ${{ needs.setup.outputs.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.setup.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${GITHUB_SHA:0:7}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ¯ Job Status" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§ª Validation | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“± iOS Build | ${{ needs.build-ios.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ¤– Android Build | ${{ needs.build-android.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”„ OTA Update | ${{ needs.ota-update.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸª Store Deploy | ${{ needs.deploy-stores.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.validate.result }}" == "success" ]]; then
            echo "âœ… **Deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“± Next Steps:" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ needs.setup.outputs.environment }}" == "production" ]]; then
              echo "- Monitor app store review process" >> $GITHUB_STEP_SUMMARY
              echo "- Check crash reporting and analytics" >> $GITHUB_STEP_SUMMARY
              echo "- Prepare release notes for users" >> $GITHUB_STEP_SUMMARY
            else
              echo "- Test the preview build thoroughly" >> $GITHUB_STEP_SUMMARY
              echo "- Validate OTA updates are working" >> $GITHUB_STEP_SUMMARY
              echo "- Share build with QA team" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **Deployment failed.** Please check the logs above." >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ’¬ Notify team
        if: needs.setup.outputs.environment == 'production'
        uses: actions/github-script@v6
        with:
          script: |
            const title = `ğŸš€ Mobile App v${{ needs.setup.outputs.version }} Deployed to Production`;
            const body = `The PRIMOTEX ERP Mobile app has been successfully deployed to production!
            
            **ğŸ“± Deployment Details:**
            - Version: ${{ needs.setup.outputs.version }}
            - Platform: ${{ needs.setup.outputs.platform }}
            - Commit: ${context.sha.substring(0, 7)}
            - Build: #${{ github.run_number }}
            
            **ğŸª Store Status:**
            - iOS: Submitted to App Store
            - Android: Submitted to Google Play (Internal Track)
            
            The app should be available for review within 24-48 hours.`;
            
            // Create issue for tracking
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['deployment', 'mobile', 'production']
            });